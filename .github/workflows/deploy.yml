name: Pipeline de Deploy

on:
  push:
    branches:
      - master

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v2

    - name: Build da aplica√ß√£o
      run: npm install && CI=false npm run build

    - name: Testes
      run: npm test

    #- name: DAST
      # Execute o teste DAST aqui usando uma ferramenta como OWASP ZAP.
  
  scans:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v2

    - name: Verificar diret√≥rio atual
      run: echo ${pwd}
    
    - name: Pull OWASP
      run: docker pull owasp/zap2docker-weekly
    
    - name: Run ZAP API Scan
      run: |
        sudo docker run -v ${pwd}:zap/wrk/:rw -t owasp/zap2docker-weekly zap-api-scan.py -t openapi.json -f openapi -c api-scan.conf


  docker_upload:
    needs: build_and_test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v2

    - name: Login no DockerHub
      run: docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build e Envio da imagem Docker
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/deploypuc:testeDeploy1 .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/deploypuc:testeDeploy1
  
  deploy:
    needs: docker_upload
    runs-on: ubuntu-latest
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v2

    - name: Listar conte√∫do do diret√≥rio
      run: ls -la

    - name: Build
      run: npm install && CI=false npm run build

    - name: Deploy no GitHub Pages
      uses: crazy-max/ghaction-github-pages@v1
      with:
        target_branch: gh-pages
        build_dir: build
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}
    
    - name: Notifica√ß√£o Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üöÄ **Novo Deploy Realizado** üöÄ

          **Status do Build:** Conclu√≠do com sucesso
          **Vers√£o do Aplicativo:** 1.0.0
          **Link para o Projeto:** [Acessar Projeto](https://gabrielsadrc.github.io/projeto-puc/)

          ‚úÖ O deploy foi realizado com sucesso!

          üëè Parab√©ns √† equipe pelo excelente trabalho!
